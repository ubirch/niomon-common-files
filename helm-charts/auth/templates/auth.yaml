{{- define "niomon-auth.env" -}}
- name: C8Y_BASEURL
  value: https://ubirch.cumulocity.com/
- name: C8Y_TENANT
  value: ubirch
- name: UBIRCH_AUTH_URL
  value: "{{.Values.auth.ubirchAuthUrl}}"
- name: KAFKA_TOPIC_IN
  value: "ubirch-niomon-req-bin"
- name: KAFKA_TOPIC_OUT_AUTH
  value: "ubirch-niomon-req-authorized-bin"
- name: KAFKA_TOPIC_OUT_UNAUTH
  value: "ubirch-niomon-error-json"
- name: REDIS_MASTER_URL
  value: "{{.Values.redis.masterURL}}"
- name: REDIS_SLAVE_URL
  value: "{{.Values.redis.slaveURL}}"
- name: REDIS_PASSWORD
  valueFrom:
    secretKeyRef:
      key: password
      name: {{.Values.redisSecretName}}
{{- end -}}

{{- $deployment := (dict "envStr" (include "niomon-auth.env" .)) -}}

{{- $_ := set $deployment "Root" . -}}
{{- $_ := set $deployment "name" "auth" -}}
{{- $_ := set $deployment "replicas" .Values.auth.replicas -}}

{{ template "niomon.deployment" $deployment }}

---

{{ template "niomon.service" $deployment }}

---

{{ template "niomon.prometheus.monitor" $deployment}}
